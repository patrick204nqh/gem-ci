name: Standardized Notifications
description: 'Send standardized notifications for workflow events using official Slack action'

inputs:
  slack-bot-token:
    description: 'Slack bot token for API calls'
    required: false
  slack-channel-id:
    description: 'Slack channel ID to send notifications'
    required: false
  message:
    description: 'Notification message'
    required: true
  status:
    description: 'Status (success, failure, warning)'
    required: true
  github-token:
    description: 'GitHub token for API calls'
    required: false

runs:
  using: composite
  steps:
    - name: üì¢ Prepare notification data
      shell: bash
      run: |
        set -euo pipefail
        
        # Set status emoji and color based on status
        case "${{ inputs.status }}" in
          success)
            EMOJI="‚úÖ"
            COLOR="good"
            ;;
          failure)
            EMOJI="‚ùå"
            COLOR="danger"
            ;;
          warning)
            EMOJI="‚ö†Ô∏è"
            COLOR="warning"
            ;;
          *)
            EMOJI="‚ÑπÔ∏è"
            COLOR="#0066cc"
            ;;
        esac
        
        # Export environment variables for use in Slack action
        echo "NOTIFICATION_EMOJI=$EMOJI" >> $GITHUB_ENV
        echo "NOTIFICATION_COLOR=$COLOR" >> $GITHUB_ENV
        
        # Format workflow run URL
        WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "WORKFLOW_URL=$WORKFLOW_URL" >> $GITHUB_ENV
        
        # Format commit info
        COMMIT_SHORT="${{ github.sha }}"
        COMMIT_SHORT="${COMMIT_SHORT:0:7}"
        echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_ENV
    
    - name: üí¨ Send Slack notification
      if: inputs.slack-bot-token != '' && inputs.slack-channel-id != ''
      uses: slackapi/slack-github-action@v1.27.0
      with:
        channel-id: ${{ inputs.slack-channel-id }}
        payload: |
          {
            "text": "${{ env.NOTIFICATION_EMOJI }} ${{ github.workflow }} - ${{ inputs.status }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ env.NOTIFICATION_EMOJI }} ${{ github.workflow }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n${{ github.repository }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n${{ inputs.status }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.ref_name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ env.COMMIT_SHORT }}>"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Message:*\n${{ inputs.message }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow Run"
                    },
                    "url": "${{ env.WORKFLOW_URL }}",
                    "style": "primary"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_BOT_TOKEN: ${{ inputs.slack-bot-token }}
    
    - name: ‚ÑπÔ∏è Log notification status
      shell: bash
      run: |
        if [ -n "${{ inputs.slack-bot-token }}" ] && [ -n "${{ inputs.slack-channel-id }}" ]; then
          echo "‚úÖ Slack notification sent successfully"
          echo "üì± Channel: ${{ inputs.slack-channel-id }}"
          echo "üìù Message: ${{ inputs.message }}"
          echo "üîó Workflow: ${{ env.WORKFLOW_URL }}"
        else
          echo "‚ÑπÔ∏è Slack notification skipped (missing token or channel)"
        fi