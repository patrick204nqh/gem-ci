# ğŸ§ª Validation Workflows
# This folder contains validation workflows that test gem-ci setup and functionality
# These are separate from production workflows (01-08) that get copied by the CLI tool

name: "ğŸ›¡ï¸ Validate Repository Rulesets"
on:
  workflow_dispatch:

jobs:
  validate-rulesets:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ”„ Checkout Repository"
        uses: actions/checkout@v4
      
      - name: "ğŸ”‘ Generate GitHub App Token"
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GEM_CI_APP_ID }}
          private-key: ${{ secrets.GEM_CI_PRIVATE_KEY }}
      
      - name: "ğŸ” Validate Rulesets Configuration Files"
        run: |
          echo "ğŸ§ª Checking for rulesets configuration..."
          
          ruleset_files=(
            ".github/config/rulesets/branch-protection.json"
            ".github/config/rulesets/tag-protection.json"
            ".github/config/rulesets/push-restrictions.json"
            ".github/rulesets.json"
          )
          
          found_files=()
          for file in "${ruleset_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
              echo "ğŸ“„ File size: $(wc -c < "$file") bytes"
              found_files+=("$file")
            else
              echo "âŒ Missing: $file"
            fi
          done
          
          if [ ${#found_files[@]} -eq 0 ]; then
            echo "âŒ No ruleset configuration files found!"
            echo "ğŸ’¡ Expected at least one of:"
            printf '  %s\n' "${ruleset_files[@]}"
            exit 1
          else
            echo "ğŸ‰ Found ${#found_files[@]} ruleset configuration file(s)"
          fi
      
      - name: "ğŸ“‹ Parse and Validate Ruleset JSON Structure"
        run: |
          echo "ğŸ§ª Validating ruleset JSON structure..."
          
          for file in .github/config/rulesets/*.json .github/rulesets.json; do
            if [ -f "$file" ]; then
              echo "ğŸ” Validating: $file"
              
              # Validate JSON syntax
              if jq empty "$file" 2>/dev/null; then
                echo "âœ… Valid JSON syntax"
              else
                echo "âŒ Invalid JSON syntax in $file"
                exit 1
              fi
              
              # Check for required ruleset fields
              if jq -e 'has("name")' "$file" > /dev/null; then
                ruleset_name=$(jq -r '.name' "$file")
                echo "âœ… Ruleset name: $ruleset_name"
              else
                echo "âŒ Missing required field: name"
                exit 1
              fi
              
              if jq -e 'has("target")' "$file" > /dev/null; then
                target=$(jq -r '.target' "$file")
                echo "âœ… Target: $target"
              else
                echo "âŒ Missing required field: target"
                exit 1
              fi
              
              if jq -e 'has("rules")' "$file" > /dev/null; then
                rule_count=$(jq '.rules | length' "$file")
                echo "âœ… Rules defined: $rule_count"
              else
                echo "âŒ Missing required field: rules"
                exit 1
              fi
              
              echo "ğŸ“‹ Ruleset summary:"
              echo "  Name: $(jq -r '.name' "$file")"
              echo "  Target: $(jq -r '.target' "$file")"
              echo "  Enforcement: $(jq -r '.enforcement // "active"' "$file")"
              echo "  Rules: $(jq '.rules | length' "$file")"
              echo ""
            fi
          done
      
      - name: "ğŸ” Fetch Current Repository Rulesets"
        run: |
          echo "ğŸ§ª Fetching current repository rulesets..."
          
          # Note: This requires repository admin permissions
          current_rulesets=$(curl -s \
            -H "Authorization: token ${{ steps.app_token.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${{ github.api_url }}/repos/${{ github.repository }}/rulesets" || echo "[]")
          
          if [ "$current_rulesets" = "[]" ] || [ -z "$current_rulesets" ]; then
            echo "ğŸ“Š Current rulesets: 0 (or insufficient permissions)"
          else
            ruleset_count=$(echo "$current_rulesets" | jq '. | length' 2>/dev/null || echo "0")
            echo "ğŸ“Š Current rulesets in repository: $ruleset_count"
            
            if [ "$ruleset_count" -gt 0 ]; then
              echo "ğŸ›¡ï¸ Current rulesets:"
              echo "$current_rulesets" | jq -r '.[] | "  \(.name) (\(.target)) - \(.enforcement)"' 2>/dev/null || echo "  (Unable to parse ruleset details)"
            fi
          fi
      
      - name: "ğŸ” Validate Standard gem-ci Ruleset Patterns"
        run: |
          echo "ğŸ§ª Checking for standard gem-ci ruleset patterns..."
          
          # Define expected ruleset patterns
          expected_patterns=(
            "Branch Protection"
            "Main Branch Protection" 
            "Release Branch Protection"
            "Tag Protection"
            "Push Restrictions"
            "Required Status Checks"
            "Require Pull Request Reviews"
            "Dismiss Stale Reviews"
            "Require Signed Commits"
          )
          
          found_patterns=()
          for file in .github/config/rulesets/*.json .github/rulesets.json; do
            if [ -f "$file" ]; then
              ruleset_name=$(jq -r '.name' "$file" 2>/dev/null || echo "")
              rules=$(jq -r '.rules[].type' "$file" 2>/dev/null || echo "")
              
              for pattern in "${expected_patterns[@]}"; do
                if echo "$ruleset_name $rules" | grep -qi "$pattern"; then
                  echo "âœ… Found pattern: $pattern"
                  found_patterns+=("$pattern")
                  break
                fi
              done
            fi
          done
          
          unique_patterns=($(printf '%s\n' "${found_patterns[@]}" | sort -u))
          
          echo "ğŸ“Š Found ${#unique_patterns[@]} standard patterns out of ${#expected_patterns[@]}"
          
          if [ ${#unique_patterns[@]} -lt 3 ]; then
            echo "âš ï¸ Consider adding more comprehensive rulesets"
            echo "ğŸ’¡ Missing common patterns:"
            for pattern in "${expected_patterns[@]}"; do
              if ! printf '%s\n' "${found_patterns[@]}" | grep -qi "$pattern"; then
                echo "  - $pattern"
              fi
            done
          fi
      
      - name: "ğŸ§ª Test Ruleset Schema Validation"
        run: |
          echo "ğŸ§ª Testing ruleset schema validation..."
          
          # Create a minimal test ruleset
          cat > test-ruleset.json << 'EOF'
          {
            "name": "Test Validation Ruleset",
            "target": "branch",
            "enforcement": "evaluate",
            "conditions": {
              "ref_name": {
                "include": ["refs/heads/test-*"],
                "exclude": []
              }
            },
            "rules": [
              {
                "type": "deletion"
              },
              {
                "type": "required_status_checks",
                "parameters": {
                  "required_status_checks": [
                    {
                      "context": "ci/test"
                    }
                  ]
                }
              }
            ]
          }
          EOF
          
          # Validate the test ruleset
          if jq empty test-ruleset.json; then
            echo "âœ… Test ruleset has valid JSON structure"
            
            # Check required fields
            required_fields=("name" "target" "rules")
            for field in "${required_fields[@]}"; do
              if jq -e "has(\"$field\")" test-ruleset.json > /dev/null; then
                echo "âœ… Test ruleset has required field: $field"
              else
                echo "âŒ Test ruleset missing field: $field"
              fi
            done
            
            echo "ğŸ“‹ Test ruleset details:"
            echo "  Name: $(jq -r '.name' test-ruleset.json)"
            echo "  Target: $(jq -r '.target' test-ruleset.json)"
            echo "  Enforcement: $(jq -r '.enforcement' test-ruleset.json)"
            echo "  Rules: $(jq '.rules | length' test-ruleset.json)"
          else
            echo "âŒ Test ruleset has invalid JSON"
            exit 1
          fi
          
          # Clean up
          rm test-ruleset.json
      
      - name: "ğŸ” Check Repository Permissions"
        run: |
          echo "ğŸ§ª Checking repository permissions for ruleset management..."
          
          # Check if we have admin access (needed for rulesets)
          repo_perms=$(curl -s \
            -H "Authorization: token ${{ steps.app_token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}" | jq -r '.permissions // {}')
          
          if [ "$repo_perms" != "{}" ]; then
            admin=$(echo "$repo_perms" | jq -r '.admin // false')
            push=$(echo "$repo_perms" | jq -r '.push // false')
            
            echo "ğŸ“Š Repository permissions:"
            echo "  Admin: $admin"
            echo "  Push: $push"
            
            if [ "$admin" = "true" ]; then
              echo "âœ… Admin permissions available for ruleset management"
            else
              echo "âš ï¸ Admin permissions required for full ruleset management"
              echo "ğŸ’¡ Current permissions may limit ruleset operations"
            fi
          else
            echo "âš ï¸ Unable to determine repository permissions"
          fi
      
      - name: "âœ… Repository Rulesets Validation Complete"
        run: |
          echo "ğŸ‰ Repository rulesets validation completed!"
          echo "ğŸ“‹ Summary:"
          echo "  âœ… Configuration files: Validated"
          echo "  ğŸ“‹ JSON structure: Valid"
          echo "  ğŸ›¡ï¸ Current rulesets: Checked"
          echo "  ğŸ” Permissions: Verified"
          echo ""
          echo "ğŸ’¡ Next steps:"
          echo "  1. Review and update ruleset configurations"
          echo "  2. Import rulesets to repository settings"
          echo "  3. Test ruleset enforcement"
          echo "  4. Document ruleset management process"
          echo ""
          echo "ğŸ“š Import instructions:"
          echo "  â€¢ Go to Settings > Rules > Rulesets"
          echo "  â€¢ Click 'New ruleset' > 'Import a ruleset'"
          echo "  â€¢ Upload your JSON configuration files"
          echo "  â€¢ Review and activate rulesets" 